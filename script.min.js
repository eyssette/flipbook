let portrait=!1;const portraitThreshold=290;let yamlMaths,yamlStyle;const bookElement=document.getElementById("book");function convertLatexExpressions(e){let t=(e=e.replace(/\$\$(.*?)\$\$/g,"&#92;[$1&#92;]").replace(/\$(.*?)\$/g,"&#92;($1&#92;)")).match(new RegExp(/&#92;\[.*?&#92;\]|&#92;\(.*?&#92;\)/g));if(t)for(let n of t){const t=!!n.includes("&#92;[");let i=n.replace("&#92;[","").replace("&#92;]","");i=i.replace("&#92;(","").replace("&#92;)",""),stringWithLatex=katex.renderToString(i,{displayMode:t}),e=e.replace(n,stringWithLatex)}return e}let pages;function resetIframe(e){const t=e.src;e.blur(),e.src="",e.src=t}function focusOutIframe(){if(activeIframe=document.activeElement,"iframe"==activeIframe.type)resetIframe(activeIframe);else for(const e of pages)"block"==e.style.display&&(iframe=e.querySelector("iframe"),iframe&&resetIframe(iframe))}function isEven(e){return e%2==0}function updateCurrentPageCounter(e,t){let n="";n=0==(e=isEven(e)?e:e+1)?"1":e==t||portrait?e:e+"-"+(e+1),document.querySelector(".page-current").innerText=n}function createBook(e,t){pages=document.querySelectorAll(".page");const n=window.location.hash.substring(1),i=window.location.origin+window.location.pathname,a=new URLSearchParams(document.location.search),o=parseInt(a.get("page"))?parseInt(a.get("page")):0;let r=isEven(o)?o:o-1;e<portraitThreshold&&(portrait=!0,e=90*window.innerWidth/100,t=80*window.innerHeight/100);const s=new St.PageFlip(bookElement,{width:e,height:t,showCover:!0,usePortrait:portrait,flippingTime:500,startPage:r});for(const n of pages)n.style.width=e+"px",n.style.height=t+"px";const l=/h:(.*)?%/;imagesToResize=document.querySelectorAll('img[alt*="h:"]'),imagesToResize.forEach(e=>{setImageHeight=e.alt.match(l)?e.alt.match(l)[1]:void 0,setImageHeight&&(e.style.height=setImageHeight+"vh",e.style.maxWidth="")}),textFit(pages,{multiLine:!0,alignHoriz:!0,alignVert:!0}),s.loadFromHTML(document.querySelectorAll(".page"));const u=s.getPageCount();function c(e){const t=i+"?page="+e+"#"+n;history.pushState({path:t},"",t)}function d(){r>1?r-=2:r=0,s.flipPrev(),c(r)}function m(){0==r?r+=2:r=r+2<=u?r+2:r,s.flipNext(),c(r)}document.querySelector(".page-total").innerText=u,updateCurrentPageCounter(r,u),document.querySelector(".btn-prev").addEventListener("click",()=>{d()}),document.querySelector(".btn-next").addEventListener("click",()=>{m()}),document.addEventListener("keydown",function(e){"ArrowLeft"===e.key&&d(),"ArrowRight"===e.key&&m()}),s.on("flip",e=>{focusOutIframe(),updateCurrentPageCounter(e.data,u)});const p=document.querySelectorAll('a[href*="?page"]'),g=/\?page=([0-9]+)/;for(const e of p)e.addEventListener("click",e=>{e.preventDefault();const t=e.target.href.match(g);if(t){const e=parseInt(t[1]);s.flip(e-1),c(e),updateCurrentPageCounter(r=isEven(e)?e:e-1,u)}})}function calculateDimensions(){let e=40*window.innerWidth/100,t=e/500*600;const n=85*window.innerHeight/100;return t>n&&(e=(t=n)/600*500),[e,t]}function changeToHardPages(){document.querySelectorAll(".page").forEach(e=>{e.setAttribute("data-density","hard")})}function createFlipbook(){const[e,t]=calculateDimensions();e<portraitThreshold&&changeToHardPages(),createBook(e,t),setTimeout(()=>{yamlMaths&&(contentDivs=document.querySelectorAll(".textFitted"),contentDivs.forEach(e=>{e.innerHTML=convertLatexExpressions(e.innerHTML)}))},200);let n,i=window.innerWidth;function a(){newWindowWidth=window.innerWidth,document.fullscreenElement||i==newWindowWidth||location.reload(),document.fullscreenElement||(focusOutIframe(),i=newWindowWidth)}window.addEventListener("resize",function(){clearTimeout(n),n=setTimeout(a,250)})}const shortcuts=[["modèle","https://codimd.apps.education.fr/NuU3detpS0amHKFZ1ImX8Q"]];let md="---\nstyle: small{font-size:0.7em}\n---\n\n# Flipbook\n\nUn outil [libre](https://forge.apps.education.fr/flipbook/flipbook.forge.apps.education.fr) & gratuit pour créer facilement un livre numérique que l'on peut feuilleter en ligne\n\n<small>Créé par : [Cédric Eyssette](https://eyssette.forge.apps.education.fr/)</small>\n\n---\n\nOn peut créer son flipbook sur [CodiMD](https://codimd.apps.education.fr/).\n\nOn peut aussi utiliser d'autres outils accessibles aux élèves comme [Digipage](https://digipage.app/), [Framapad](https://framapad.org/abc/fr/) ou [Hedgedoc](https://demo.hedgedoc.org/).\n\n---\n\nLe flipbook sera alors à cette adresse :\n\n```md\nhttps://flipbook.\nforge.apps.\neducation.fr/\n#URL_DU_FLIPBOOK\n```\n\nDans son fichier, on sépare simplement chaque page avec l'élément : ```---```\n\n\n---\n\nOn peut utiliser toute la syntaxe Markdown ou HTML.\n\n- Par exemple,\n- une liste\n- d'éléments\n\n---\n\n## La taille de la police est ajustée automatiquement pour que le contenu tienne sur la page.\n\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam bibendum mauris nec venenatis convallis. Vivamus ultrices fermentum dapibus. Sed quis erat maximus, scelerisque tellus eget, suscipit nisl. Donec vulputate purus ultricies dolor tristique bibendum. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam consectetur vel diam non eleifend. Proin ultrices leo pulvinar ipsum lobortis, vel sodales quam sagittis.\nNam sed libero magna. Aliquam ut eleifend libero, ac malesuada massa. Nulla iaculis mi nisl, vitae tempor mi volutpat eu. Aliquam erat volutpat. Mauris sodales ultrices ante, maximus pulvinar dolor. Nullam mattis sem non orci mollis porttitor. Sed aliquam eros velit. Fusce interdum enim sed volutpat accumsan. Proin consequat, nisi in congue varius, ipsum erat elementum elit, eget mollis metus nulla eget risus. Donec aliquet, massa quis feugiat congue, lacus tellus elementum sapien, nec iaculis libero nunc vitae mi. Curabitur eget felis in sapien aliquam volutpat vel vitae urna. Quisque a ipsum a massa convallis eleifend. Nulla facilisi.\nMorbi justo diam, pellentesque quis porta ac, pulvinar nec elit. Ut dignissim efficitur libero non convallis. Nullam eu tincidunt libero, sed tempus elit. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer a imperdiet sem, vel eleifend purus. Nullam urna enim, mollis sit amet augue eget, sodales euismod erat. Maecenas maximus arcu eu volutpat bibendum. Duis placerat malesuada libero, et feugiat massa feugiat sit amet. Donec auctor lacinia pellentesque. Donec molestie dolor bibendum, luctus lacus a, euismod lorem. Aliquam elementum quam id ex ornare auctor. Maecenas interdum, ligula eleifend viverra posuere, sem massa mattis velit, nec aliquet turpis urna vitae erat. Vestibulum eu purus nibh.\n\n---\n\n## Images\n\nOn peut insérer des images, mais il faut leur donner une hauteur pour que la police soit ajustée correctement.\n\n![h:20%](https://picsum.photos/500/300)\n\nOn peut indiquer une dimension en pixels :\n`![](URL_image =x300)`\n\nOu en pourcentage de la hauteur de l'écran :\n`![h:40%](URL_image)`\n\nOn peut enfin utiliser une image en fond de page en ajoutant `bg` au début du `alt` de l'image.\n`![bg](URL_image)`\n\n---\n\n### Configuration plus avancée\n\nOn peut ajouter un en-tête YAML pour accéder à certaines options.\n\n```\n``​`​\nmaths: true\nstyle: p{color:red}\n`​`​`​\n```\n\n- `maths: true` permet d'utiliser des formules mathématiques en Latex\n- `style: p{color:red}` permet d'ajouter des styles personnalisés en CSS\n\n---\n\nOn peut insérer un sommaire en écrivant : `!​summary`. Seuls les titres de niveau 2 seront pris en compte dans le sommaire.\n\n\nPour avoir un lien vers une page spécifique, on écrit :\n`[lien vers page 5](?page=5)`\n\nExemple :\n[lien vers la page 3](?page=3)\n\n\n";function showdownExtensionAdmonitions(){return[{type:"output",filter:e=>{const t=(e=e.replaceAll("<p>:::",":::")).match(/:::(.*?)\n(.*?):::/gs);if(t){let n=e;for(const i of t){const t=/:::(.*?)\s(.*?)\n(.*?):::/s.exec(i),a=e.indexOf(i);if(!("<code>"==e.substring(a-6,a))){let e=t[1],a=t[2];e.includes("<br")&&(e=e.replace("<br",""),a="");const o=t[3];a.includes("collapsible")?(a=a.replace("collapsible",""),matchReplaced=`<div><div class="admonition ${e}"><details><summary class="admonitionTitle">${a}</summary><div class="admonitionContent">${o}</div></details></div></div>`):matchReplaced=`<div><div class="admonition ${e}"><div class="admonitionTitle">${a}</div><div class="admonitionContent">${o}</div></div></div>`,n=n.replaceAll(i,matchReplaced)}}return n}return e}}]}const showdownExtensionUnderline={type:"lang",regex:/\+\+(.*?)\+\+/g,replace:"<u>$1</u>"},showdownExtensionHighlight={type:"lang",regex:/\=\=(.*?)\=\=/g,replace:"<mark>$1</mark>"},converter=new showdown.Converter({emoji:!0,parseImgDimensions:!0,simpleLineBreaks:!0,simplifiedAutoLink:!0,tables:!0,openLinksInNewWindow:!0,extensions:[showdownExtensionAdmonitions,showdownExtensionUnderline,showdownExtensionHighlight]});function markdownToHTML(e){let t=converter.makeHtml(e);return t=t.replaceAll("<img ",'<img loading="lazy" ')}let flipbookData,urlMD;function getMarkdownContent(){if(""!==(urlMD=window.location.hash.substring(1))){const e=shortcuts.find(e=>e[0]==urlMD);e&&(urlMD=e[1]),urlMD.startsWith("https://github.com")&&(urlMD=(urlMD=urlMD.replace("https://github.com","https://raw.githubusercontent.com")).replace("/blob/","/")),(urlMD.startsWith("https://codimd")||urlMD.includes("hedgedoc")||urlMD.includes("digipage"))&&(urlMD=-1===(urlMD=urlMD.replace("?edit","").replace("?both","").replace("?view","").replace(/#$/,"").replace(/\/$/,"")).indexOf("download")?urlMD+"/download":urlMD),!urlMD.includes("framapad")&&!urlMD.includes("digidoc")||urlMD.endsWith("/export/txt")||(urlMD=urlMD.replace(/\?.*/,"")+"/export/txt"),fetch(urlMD).then(e=>e.text()).then(e=>{createHTMLelements(flipbookData=parseMarkdown(md=e)),createFlipbook()}).catch(e=>console.error(e))}else createHTMLelements(parseMarkdown(md)),createFlipbook()}function fixImageDimensionsCodiMD(e){return e=(e=e.replaceAll(/=x([0-9]*)\)/g,"=*x$1)")).replaceAll(/=([0-9]*)x\)/g,"=$1x*)")}function splitText(e){let t=[],n=e.split("---"),i="";for(let e=0;e<n.length;e++)n[e].endsWith("`")?i+=n[e]+"---":(i+=n[e],t.push(i),i="");return t}function loadScript(e){return new Promise((t,n)=>{const i=document.createElement("script");i.src=e,i.onload=t,i.onerror=n,document.head.appendChild(i)})}function loadCSS(e){return new Promise((t,n)=>{const i=document.createElement("link");i.href=e,i.rel="stylesheet",i.onload=t,i.onerror=n,document.head.appendChild(i)})}function parseMarkdown(e){let t=[];const n=splitText(e=fixImageDimensionsCodiMD(e));if(n.length>2&&e.startsWith("---")){try{yamlData=jsyaml.load(n[1]);for(const e in yamlData)if("maths"==e&&!0===(yamlMaths=yamlData[e])&&Promise.all([loadScript("https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"),loadCSS("https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css")]),"style"==e){yamlStyle=yamlData[e];const t=document.createElement("style");t.innerHTML=yamlStyle.replaceAll("\\",""),document.body.appendChild(t)}}catch(e){}if(n.shift(),n.shift(),t=n,e.includes("!summary")){let e=-1;const n=/(\n|^)## (.*)/;let i=[];for(const[a,o]of t.entries())if(e>-1){const e=o.match(n);if(e){const t=e[2];i.push('<li><a href="?page='+(a+1)+'">'+t+"</a></li>")}}else o.includes("!summary")&&(e=a);const a='<ul class="summary">'+i.join("\n")+"</ul>";t[e]=t[e].replace("!summary",a)}}else t=n;return t}function createHTMLelements(e){const t=/.*src="(.*?)" alt="bg.*/;for(let n=0;n<e.length;n++){let i=markdownToHTML(e[n]);const a=document.createElement("div");i.includes('alt="bg')&&(i=i.replace(t,function(e,t){return"<style>div.page:nth-of-type("+(n+1)+'){background-image:url("'+t+'"); background-size: contain; background-repeat: no-repeat; background-position: center center;}</style>'})),a.innerHTML=i,a.classList.add("page"),0!==n&&n!==e.length-1||a.setAttribute("data-density","hard"),document.body.appendChild(a)}}getMarkdownContent();